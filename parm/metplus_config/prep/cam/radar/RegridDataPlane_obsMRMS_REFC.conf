# Regridding MRMS Composite Reflectivity Options

[config]
# Final conf file used by all processes
LOG_DIR = {OUTPUT_BASE}/logs
METPLUS_CONF = {TMP_DIR}/metplus_final_RegridDataPlane_REFC_{ENV[DOMAIN]}.conf
LOG_METPLUS = {TMP_DIR}/run_metplus.MRMS_REFC_{ENV[DOMAIN]}.log.{LOG_TIMESTAMP_TEMPLATE}
SCRUB_STAGING_DIR = False

#
LOOP_ORDER = processes

# List of applications to run
PROCESS_LIST = RegridDataPlane(to_verf_grid), RegridDataPlane(max_filter), GenEnsProd, RegridDataPlane(PPF) 


# if false, loop by VALID time
LOOP_BY = VALID

# Format of VALID_BEG and VALID_END
VALID_TIME_FMT = %Y%m%d%H

# Start and end time for METplus run
VALID_BEG = {ENV[VDATE]}{ENV[vhr]}
VALID_END = {ENV[VDATE]}{ENV[vhr]}

# Increment between METplus runs in seconds. Must be >= 60
VALID_INCREMENT = 3600

# Info on forecast leads and init to process
LEAD_SEQ = 0


# Observations variable information
OBTYPE = MRMS


# Regrid obs data before running GridStat
FCST_REGRID_DATA_PLANE_RUN = False
OBS_REGRID_DATA_PLANE_RUN = True

REGRID_DATA_PLANE_SKIP_IF_OUTPUT_EXISTS = True

# Used by all RegridDataPlane instances
REGRID_DATA_PLANE_VERIF_GRID = {ENV[VERIF_GRID]} 


GEN_ENS_PROD_CONFIG_FILE = {PARM_BASE}/met_config/GenEnsProdConfig_wrapped

ENS_VAR1_NAME = {ENV[OBS_VAR]}
ENS_VAR1_LEVELS = Z500
ENS_VAR1_THRESH = ge20, ge30, ge40, ge50

GEN_ENS_PROD_N_MEMBERS = 1
GEN_ENS_PROD_ENS_THRESH = 1.0

GEN_ENS_PROD_CENSOR_THRESH = ==-9999
GEN_ENS_PROD_CENSOR_VAL = 0.0

GEN_ENS_PROD_ENSEMBLE_FLAG_LATLON = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_MEAN = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_STDEV = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_MINUS = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_PLUS = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_MIN = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_MAX = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_RANGE = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_VLD_COUNT = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_FREQUENCY = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_NEP = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_NMEP = FALSE

GEN_ENS_PROD_INPUT_DIR = {OUTPUT_BASE}/MRMS_{ENV[DOMAIN]}_tmp
GEN_ENS_PROD_INPUT_TEMPLATE = {ENS_VAR1_NAME}_MAX40_{valid?fmt=%Y%m%d}-{valid?fmt=%H%M%S}.{ENV[VERIF_GRID]}.nc 

GEN_ENS_PROD_OUTPUT_DIR = {OUTPUT_BASE}/MRMS_{ENV[DOMAIN]}
GEN_ENS_PROD_OUTPUT_TEMPLATE = {ENS_VAR1_NAME}_ENS_FREQ_{valid?fmt=%Y%m%d}-{valid?fmt=%H%M%S}.{ENV[VERIF_GRID]}.nc


# Run RegridDataPlane to regrid obs to verification grid
[to_verf_grid]

OBS_VAR1_NAME = {ENS_VAR1_NAME}
OBS_VAR1_LEVELS = {ENS_VAR1_LEVELS}
OBS_VAR1_OPTIONS = censor_thresh = eq-999; censor_val = -9999;

REGRID_DATA_PLANE_METHOD = BUDGET
REGRID_DATA_PLANE_WIDTH = 2

OBS_REGRID_DATA_PLANE_INPUT_DATATYPE = GRIB

OBS_REGRID_DATA_PLANE_INPUT_DIR = {OUTPUT_BASE}/MRMS_{ENV[DOMAIN]}_tmp
OBS_REGRID_DATA_PLANE_INPUT_TEMPLATE = {ENS_VAR1_NAME}_00.50_{valid?fmt=%Y%m%d}-{valid?fmt=%H%M%S}.grib2

OBS_REGRID_DATA_PLANE_OUTPUT_DIR = {OUTPUT_BASE}/MRMS_{ENV[DOMAIN]}
OBS_REGRID_DATA_PLANE_OUTPUT_TEMPLATE = {ENS_VAR1_NAME}_00.50_{valid?fmt=%Y%m%d}-{valid?fmt=%H%M%S}.{ENV[VERIF_GRID]}.nc


# Run RegridDataPlane to create 40-km max field
[max_filter]

OBS_REGRID_DATA_PLANE_VAR1_INPUT_FIELD_NAME = {ENS_VAR1_NAME}
OBS_REGRID_DATA_PLANE_VAR1_INPUT_LEVEL = {ENS_VAR1_LEVELS}
OBS_REGRID_DATA_PLANE_VAR1_OUTPUT_FIELD_NAME = {ENS_VAR1_NAME} 

REGRID_DATA_PLANE_METHOD = MAX
REGRID_DATA_PLANE_WIDTH = {ENV[MAX_REGRID_WIDTH]}

OBS_REGRID_DATA_PLANE_INPUT_DATATYPE = NETCDF

OBS_REGRID_DATA_PLANE_INPUT_DIR = {OUTPUT_BASE}/MRMS_{ENV[DOMAIN]}
OBS_REGRID_DATA_PLANE_INPUT_TEMPLATE = {ENS_VAR1_NAME}_00.50_{valid?fmt=%Y%m%d}-{valid?fmt=%H%M%S}.{ENV[VERIF_GRID]}.nc

OBS_REGRID_DATA_PLANE_OUTPUT_DIR = {OUTPUT_BASE}/MRMS_{ENV[DOMAIN]}_tmp
OBS_REGRID_DATA_PLANE_OUTPUT_TEMPLATE = {ENS_VAR1_NAME}_MAX40_{valid?fmt=%Y%m%d}-{valid?fmt=%H%M%S}.{ENV[VERIF_GRID]}.nc


# Run RegridDataPlane to smooth binary field into probabilities 
[PPF]

REGRID_DATA_PLANE_ONCE_PER_FIELD = False

REGRID_DATA_PLANE_METHOD = MAXGAUSS
REGRID_DATA_PLANE_WIDTH = 1
REGRID_DATA_PLANE_GAUSSIAN_DX = {ENV[VERIF_GRID_DX]}
REGRID_DATA_PLANE_GAUSSIAN_RADIUS = {ENV[GAUSS_RAD]}

OBS_REGRID_DATA_PLANE_VAR1_INPUT_FIELD_NAME = {ENS_VAR1_NAME}_{ENS_VAR1_LEVELS}_ENS_FREQ_ge20 
OBS_REGRID_DATA_PLANE_VAR2_INPUT_FIELD_NAME = {ENS_VAR1_NAME}_{ENS_VAR1_LEVELS}_ENS_FREQ_ge30 
OBS_REGRID_DATA_PLANE_VAR3_INPUT_FIELD_NAME = {ENS_VAR1_NAME}_{ENS_VAR1_LEVELS}_ENS_FREQ_ge40 
OBS_REGRID_DATA_PLANE_VAR4_INPUT_FIELD_NAME = {ENS_VAR1_NAME}_{ENS_VAR1_LEVELS}_ENS_FREQ_ge50 

OBS_REGRID_DATA_PLANE_VAR1_INPUT_LEVEL = {ENS_VAR1_LEVELS}
OBS_REGRID_DATA_PLANE_VAR2_INPUT_LEVEL = {ENS_VAR1_LEVELS}
OBS_REGRID_DATA_PLANE_VAR3_INPUT_LEVEL = {ENS_VAR1_LEVELS}
OBS_REGRID_DATA_PLANE_VAR4_INPUT_LEVEL = {ENS_VAR1_LEVELS}

OBS_REGRID_DATA_PLANE_VAR1_OUTPUT_FIELD_NAME = Prob_{ENS_VAR1_NAME}_ge20
OBS_REGRID_DATA_PLANE_VAR2_OUTPUT_FIELD_NAME = Prob_{ENS_VAR1_NAME}_ge30
OBS_REGRID_DATA_PLANE_VAR3_OUTPUT_FIELD_NAME = Prob_{ENS_VAR1_NAME}_ge40
OBS_REGRID_DATA_PLANE_VAR4_OUTPUT_FIELD_NAME = Prob_{ENS_VAR1_NAME}_ge50

OBS_REGRID_DATA_PLANE_INPUT_DIR = {OUTPUT_BASE}/MRMS_{ENV[DOMAIN]}
OBS_REGRID_DATA_PLANE_INPUT_TEMPLATE = {GEN_ENS_PROD_OUTPUT_TEMPLATE} 

OBS_REGRID_DATA_PLANE_OUTPUT_DIR = {OUTPUT_BASE}/MRMS_{ENV[DOMAIN]}
OBS_REGRID_DATA_PLANE_OUTPUT_TEMPLATE = {ENS_VAR1_NAME}_Prob_{valid?fmt=%Y%m%d}-{valid?fmt=%H%M%S}.{ENV[VERIF_GRID]}.nc
